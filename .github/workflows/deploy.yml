#===============================================================================
# GitHub Actions - CI/CD Pipeline for AI-Aros
#===============================================================================
# Builds, tests, and deploys applications via ArgoCD GitOps
#===============================================================================
name: Build and Deploy

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, closed]

env:
  REGISTRY: gcr.io/ai-aros
  IMAGE_NAME: ${{ github.event.repository.name }}
  ARGOCD_SERVER: argocd.ai-aros.com
  GITOPS_REPO: ai-aros/gitops

jobs:
  #-----------------------------------------------------------------------------
  # Build Job
  #-----------------------------------------------------------------------------
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run tests
        run: npm run test:ci
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
      
      - name: Build application
        run: npm run build
      
      - name: Run security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  #-----------------------------------------------------------------------------
  # Container Build Job
  #-----------------------------------------------------------------------------
  container-build:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
      id-token: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions@ai-aros.iam.gserviceaccount.com'
      
      - name: Configure Docker
        run: gcloud auth configure-docker gcr.io
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=,suffix=,format=short
      
      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          sbom: true
          provenance: true
      
      - name: Sign container image
        uses: sigstore/cosign-installer@v3
      
      - name: Sign image with Cosign
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}

  #-----------------------------------------------------------------------------
  # Update GitOps Repository
  #-----------------------------------------------------------------------------
  update-gitops:
    name: Update GitOps Repository
    runs-on: ubuntu-latest
    needs: container-build
    if: github.event_name != 'pull_request' || github.event.action != 'closed'
    permissions:
      contents: write
    
    steps:
      - name: Checkout GitOps Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops
      
      - name: Determine Environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "overlay=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "overlay=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "overlay=development" >> $GITHUB_OUTPUT
          fi
      
      - name: Update Image Tag
        run: |
          cd gitops
          
          # Update kustomization.yaml with new image tag
          yq e -i '.images[0].newTag = "${{ github.sha }}"' \
            apps/${{ env.IMAGE_NAME }}/overlays/${{ steps.env.outputs.overlay }}/kustomization.yaml
          
          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Commit changes
          git add -A
          git commit -m "chore(images): update ${{ env.IMAGE_NAME }} to ${{ github.sha }}

          Environment: ${{ steps.env.outputs.environment }}
          Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          [skip ci]" || echo "No changes to commit"
          
          git push
      
      - name: Create PR for Production
        if: steps.env.outputs.environment == 'staging'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops
          branch: promote/${{ env.IMAGE_NAME }}-${{ github.sha }}
          title: "Promote ${{ env.IMAGE_NAME }} to Production"
          body: |
            ## Promotion Request
            
            **Application:** ${{ env.IMAGE_NAME }}
            **Version:** ${{ github.sha }}
            **Source:** Staging
            
            ### Changes
            ${{ github.event.head_commit.message }}
            
            ### Checklist
            - [ ] Staging tests passed
            - [ ] Security scan passed
            - [ ] Approved by code owners
            
            ### Deployment
            This PR will be deployed automatically once merged.

  #-----------------------------------------------------------------------------
  # Trigger ArgoCD Sync
  #-----------------------------------------------------------------------------
  trigger-sync:
    name: Trigger ArgoCD Sync
    runs-on: ubuntu-latest
    needs: update-gitops
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - name: Trigger ArgoCD Sync
        run: |
          # Install ArgoCD CLI
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          
          # Login to ArgoCD
          ./argocd login ${{ env.ARGOCD_SERVER }} \
            --username admin \
            --password ${{ secrets.ARGOCD_PASSWORD }} \
            --grpc-web \
            --insecure
          
          # Trigger sync
          ./argocd app sync ${{ env.IMAGE_NAME }}-development \
            --prune \
            --timeout 600

  #-----------------------------------------------------------------------------
  # Run Smoke Tests
  #-----------------------------------------------------------------------------
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: trigger-sync
    if: github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Run Smoke Tests
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            URL="https://${{ env.IMAGE_NAME }}.ai-aros.com/healthz"
          else
            URL="https://${{ env.IMAGE_NAME }}-dev.ai-aros.com/healthz"
          fi
          
          # Wait for deployment
          for i in {1..30}; do
            if curl -sf "$URL"; then
              echo "✅ Smoke tests passed"
              exit 0
            fi
            echo "Waiting for deployment... ($i/30)"
            sleep 10
          done
          
          echo "❌ Smoke tests failed"
          exit 1

  #-----------------------------------------------------------------------------
  # Cleanup Preview Environment (PR Closed)
  #-----------------------------------------------------------------------------
  cleanup-preview:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    steps:
      - name: Destroy Preview Environment
        run: |
          echo "Destroying preview environment for PR #${{ github.event.pull_request.number }}"
          # Call destroy-feature-env.sh script or API
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://${{ env.ARGOCD_SERVER }}/api/v1/applications/preview-${{ env.IMAGE_NAME }}-${{ github.event.pull_request.number }} \
            -d '{"cascade": true, "propagationPolicy": "foreground"}' || true

  #-----------------------------------------------------------------------------
  # Notify on Completion
  #-----------------------------------------------------------------------------
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [smoke-tests, cleanup-preview]
    if: always()
    
    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
